# システム概要

## 目的
- 生成AIを用いたInstagram投稿（画像・キャプション・ハッシュタグ）の一貫生成、レビュー、投稿を自動化し、人的確認を維持しつつ業務効率化を図る。
- LangSmithで生成品質と運用メトリクスを計測し、プロンプトやモデル構成の継続的改善を可能にする。
- Cloudflare Workers + Hono によりエッジで低レイテンシなAPIを提供し、Queues・KV・R2・D1といったプラットフォーム機能を有機的に利用する。

## スコープ
- `/generate` `/review` `/publish` を含むAPI群と、それらに対応する非同期キュー処理、ストレージ連携、観測性・セキュリティの実装指針。
- React製のフロントエンド（人手レビューUI）と共有リソースの位置付け。
- モジュール構造、設計原則(SOLID)に基づいた責務分離、および今後の拡張を想定したアーキテクチャ設計。

## 背景要件
- Meta Graph API（Instagram Businessアカウント）との統合が必須であり、投稿は `media` 作成→`media_publish` の二段階。
- 画像生成はCloudflare WorkersのCPU制限内に収まらない可能性が高いため、外部APIやWorkers AIへの委譲とQueueによる非同期化が前提。
- ユーザー毎にブランドトーン・コンプライアンス要件が異なるため、プロンプトや評価指標を柔軟に差し替えられる必要がある。

## ステークホルダー
- **マーケティング担当者**: コンテンツレビューと承認を行い、結果を検証・フィードバックする。
- **オペレーション担当**: Meta APIやCloudflareインフラの管理、シークレット管理、障害対応を担う。
- **開発チーム**: LangChain/LangSmithワークフローやAI統合、API設計、監視運用を維持。
- **最終顧客**: Instagram閲覧者。自動生成コンテンツの品質がブランド価値に直結する。

## 成功指標
- `/generate` エンドポイントのp95レイテンシ < 800ms（画像生成は後続キューにオフロード）。
- LangSmithトレースカバレッジ 100%、評価データセットの再現率 > 95%。
- 投稿成功率 > 99%（自動リトライ含む）、失敗時の検知→通知が5分以内。
- コンテンツ品質指標（フック強度、CTA、ブランド整合性）がレビュー基準を満たす比率 > 90%。

## ハイレベルアーキテクチャ
- **Edge API層**: Cloudflare Workers + Hono。Fetchハンドラで同期処理、Queues・Cronで非同期処理を担当。
- **AIコア**: LangChain Runnable（テキスト生成）と画像生成API（Workers AI等）。LangSmithで計測。
- **データストア**: KV（短期ドラフト）、R2（画像バイナリ）、D1（永続監査・メタデータ）。
- **外部統合**: Meta Graph API、将来的なSlack/メール通知、マーケティングツール連携。
- **人手レビューUI**: Reactアプリ（`src/react-app`）でAPIを呼び、承認・修正を行う。

## ライフサイクル概要
1. クライアントが `/generate` に投稿テーマ等を送信。
2. Workerがテキスト生成と画像ジョブの起票を実施し、ドラフトをKVへ保存。
3. レビュアーがUI上で修正・承認。承認時にQueueへ発行。
4. Queueコンシューマが画像生成結果取得→Metaへアップロード→公開→D1へログ記録。
5. LangSmithとAnalytics Engineでトレース・メトリクスを蓄積し、改善ループを回す。

## 設計原則
- **SOLID**: 単一責務（サービス・ワークフローの明確化）、依存性逆転（抽象インターフェイス経由でサービスを注入）、オープン/クローズド（モジュール追加で拡張可能）。
- **Clean Architecture志向**: API層（インターフェース）、コアドメイン（ワークフロー・サービス）、インフラ層（Cloudflare依存機能）のレイヤ分割。
- **観測性first**: すべての主要操作でLangSmithトレースおよびWorkers Analyticsへのメトリクス送信。
- **非同期耐障害性**: Queue利用、冪等性キー、指数バックオフで外部APIエラーを吸収。
